<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sendinator</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            background: #1a1a1a;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        h1 {
            font-size: 2em;
            margin: 0 0 10px 0;
            color: #eee;
        }
        h2 { margin: 0 0 15px 0; color: #ddd; font-size: 1.3em; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .home-link {
            color: #888;
            text-decoration: none;
        }
        .home-link:hover { color: #aaa; text-decoration: underline; }

        /* Auth section */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: #222;
            padding: 40px;
            text-align: center;
        }
        .auth-container h2 { margin: 0 0 10px 0; }
        .auth-container p { color: #666; margin-bottom: 30px; }
        .auth-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: #444;
            color: #ddd;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-btn:hover { background: #555; }
        .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-error { color: #888; margin-top: 15px; }

        /* Admin panel */
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }

        /* Create key form */
        .create-key-section {
            background: #222;
            padding: 20px;
            margin-bottom: 20px;
        }
        .create-key-form {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.85em; color: #666; }
        .form-group input {
            padding: 10px 14px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ccc;
            font-size: 1em;
        }
        .form-group input:focus { outline: none; border-color: #555; }
        .create-btn {
            padding: 10px 20px;
            background: #444;
            color: #ddd;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .create-btn:hover { background: #555; }

        /* Keys table */
        .keys-table {
            width: 100%;
            border-collapse: collapse;
        }
        .keys-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.8em;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            user-select: none;
        }
        .keys-table th:hover { color: #888; }
        .keys-table th.active { color: #ccc; }
        .keys-table th.right { text-align: right; }
        .keys-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #2a2a2a;
            vertical-align: middle;
        }
        .keys-table tr:hover { background: rgba(255,255,255,0.02); }
        .key-actions-cell { white-space: nowrap; }
        .key-actions-cell button, .key-actions-cell a {
            padding: 4px 8px;
            font-size: 0.75em;
            cursor: pointer;
            border: 1px solid #444;
            background: transparent;
            color: #888;
            text-decoration: none;
            margin-left: 4px;
        }
        .key-actions-cell button:hover, .key-actions-cell a:hover { background: #444; color: #ddd; }
        .quota-bar-small {
            width: 60px;
            height: 4px;
            background: #333;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        .quota-bar-small .quota-fill { height: 100%; background: #555; }
        .quota-bar-small .quota-fill.warning { background: #666; }
        .quota-bar-small .quota-fill.danger { background: #777; }

        /* Files table */
        .files-table {
            width: 100%;
            border-collapse: collapse;
        }
        .files-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.8em;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            user-select: none;
        }
        .files-table th:hover { color: #888; }
        .files-table th.active { color: #ccc; }
        .files-table th.right { text-align: right; }
        .files-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #2a2a2a;
            vertical-align: middle;
        }
        .files-table tr:hover { background: rgba(255,255,255,0.02); }
        .sort-icon { margin-left: 4px; font-size: 0.8em; }

        .file-name-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-name-link {
            color: #888;
            text-decoration: none;
        }
        .file-name-link:hover { color: #aaa; text-decoration: underline; }

        .file-size-cell { color: #666; white-space: nowrap; }
        .file-date-cell { color: #666; white-space: nowrap; }
        .file-actions-cell { white-space: nowrap; }
        .file-actions-cell button {
            padding: 4px 8px;
            font-size: 0.75em;
            cursor: pointer;
            border: 1px solid #444;
            background: transparent;
            color: #888;
            margin-left: 4px;
        }
        .file-actions-cell button:hover { background: #444; color: #ddd; }

        /* Stats */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #222;
            padding: 15px 20px;
            min-width: 120px;
        }
        .stat-value { font-size: 1.5em; font-weight: 600; color: #ccc; }
        .stat-label { font-size: 0.85em; color: #666; margin-top: 4px; }

        .empty-state { text-align: center; padding: 40px 20px; color: #555; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        /* Search box */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .search-input {
            flex: 1;
            padding: 10px 14px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ccc;
            font-size: 1em;
        }
        .search-input:focus { outline: none; border-color: #555; }
        .search-input::placeholder { color: #555; }
        /* Sortable headers */
        .keys-header .sortable {
            cursor: pointer;
            user-select: none;
        }
        .keys-header .sortable:hover { color: #aaa; }
        .keys-header .sortable.active { color: #ccc; }
        .keys-header .sort-icon { margin-left: 4px; font-size: 0.8em; }
        .version { position: fixed; bottom: 10px; right: 10px; color: #333; font-size: 0.75em; }
        .new-key-display {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border: 1px solid #444;
        }
        .new-key-display label { display: block; color: #888; margin-bottom: 8px; font-size: 0.9em; }
        .new-key-value {
            font-family: monospace;
            font-size: 1.2em;
            color: #ccc;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div class="auth-container" id="authContainer">
        <h2 id="authTitle">Admin Setup</h2>
        <p id="authDesc">Create a passkey to secure your admin panel.</p>
        <button class="auth-btn" id="authBtn">Create Passkey</button>
        <div class="auth-error" id="authError"></div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1>Sendinator Admin</h1>
            <div class="header-right">
                <a href="/" class="home-link">Back to Upload</a>
                <a href="#" class="home-link" onclick="logout(); return false;">Logout</a>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalKeys">0</div>
                <div class="stat-label">Upload Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Total Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 B</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <div class="create-key-section">
            <h2>Create Upload Key</h2>
            <div class="create-key-form">
                <div class="form-group">
                    <label>Label (optional)</label>
                    <input type="text" id="keyLabel" placeholder="e.g., John's key">
                </div>
                <div class="form-group">
                    <label>Quota</label>
                    <div style="display: flex; gap: 6px;">
                        <input type="number" id="keyQuota" value="10" min="1" step="1" style="width: 80px;">
                        <select id="keyQuotaUnit" style="padding: 10px; background: #1a1a1a; border: 1px solid #333; color: #ccc;">
                            <option value="MiB">MiB</option>
                            <option value="GiB" selected>GiB</option>
                            <option value="TiB">TiB</option>
                        </select>
                    </div>
                </div>
                <button class="create-btn" onclick="createKey()">Create Key</button>
            </div>
            <div class="new-key-display" id="newKeyDisplay" style="display: none;">
                <label>New Upload Key:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="new-key-value" id="newKeyValue"></div>
                    <button class="copy-key-btn" onclick="copyNewKey()">Copy</button>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2>Manage Keys</h2>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" id="keysSearchInput" placeholder="Search keys or labels..." oninput="handleKeysSearch()">
        </div>

        <div id="keysTableContainer"></div>
        <div class="empty-state" id="keysEmpty" style="display: none;">
            No upload keys yet. Create one above to get started.
        </div>

        <div class="section-header">
            <h2>All Files</h2>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" id="filesSearchInput" placeholder="Search keys, labels, or filenames..." oninput="handleFilesSearch()">
        </div>

        <div id="filesTableContainer"></div>
        <div class="empty-state" id="filesEmpty" style="display: none;">
            No files uploaded yet.
        </div>
    </div>

    <div class="version">v3.10.1</div>

    <script>
        let keys = [];
        let orphanedUploads = [];
        let sessionToken = null;

        // Keys table state
        let keysSearchQuery = '';
        let keysSortColumn = 'label';
        let keysSortDirection = 'asc';

        // Files table state
        let filesSearchQuery = '';
        let filesSortColumn = 'filename';
        let filesSortDirection = 'asc';

        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const authTitle = document.getElementById('authTitle');
        const authDesc = document.getElementById('authDesc');
        const authBtn = document.getElementById('authBtn');
        const authError = document.getElementById('authError');
        const keysTableContainer = document.getElementById('keysTableContainer');
        const keysEmpty = document.getElementById('keysEmpty');
        const filesTableContainer = document.getElementById('filesTableContainer');
        const filesEmpty = document.getElementById('filesEmpty');

        // Check auth status on load
        async function checkAuth() {
            if (!window.PublicKeyCredential) {
                authTitle.textContent = 'Not Supported';
                authDesc.textContent = 'WebAuthn is not available. You need HTTPS or localhost.';
                authBtn.style.display = 'none';
                return;
            }

            // Try to restore session from localStorage
            const storedToken = localStorage.getItem('adminSession');
            if (storedToken) {
                try {
                    const res = await fetch('/api/admin/keys', {
                        headers: { 'Authorization': `Bearer ${storedToken}` }
                    });
                    if (res.ok) {
                        sessionToken = storedToken;
                        showAdminPanel();
                        return;
                    }
                } catch (err) {
                    // Token invalid, continue to login screen
                }
                localStorage.removeItem('adminSession');
            }

            try {
                const res = await fetch('/api/admin/status');
                const data = await res.json();

                if (!data.passkeyExists) {
                    authTitle.textContent = 'Admin Setup';
                    authDesc.textContent = 'Create a passkey to secure your admin panel.';
                    authBtn.textContent = 'Create Passkey';
                    authBtn.onclick = registerPasskey;
                } else {
                    authTitle.textContent = 'Admin Login';
                    authDesc.textContent = 'Authenticate with your passkey.';
                    authBtn.textContent = 'Login with Passkey';
                    authBtn.onclick = loginPasskey;
                }
            } catch (err) {
                authError.textContent = 'Failed to check auth status';
            }
        }

        async function registerPasskey() {
            authBtn.disabled = true;
            authError.textContent = '';
            try {
                const optionsRes = await fetch('/api/admin/register/start', { method: 'POST' });
                const options = await optionsRes.json();
                options.challenge = base64ToBuffer(options.challenge);
                options.user.id = base64ToBuffer(options.user.id);

                const credential = await navigator.credentials.create({ publicKey: options });

                const verifyRes = await fetch('/api/admin/register/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: credential.id,
                        rawId: bufferToBase64(credential.rawId),
                        type: credential.type,
                        response: {
                            clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                            attestationObject: bufferToBase64(credential.response.attestationObject)
                        }
                    })
                });

                const result = await verifyRes.json();
                if (result.success) {
                    sessionToken = result.token;
                    localStorage.setItem('adminSession', sessionToken);
                    showAdminPanel();
                } else {
                    authError.textContent = result.error || 'Registration failed';
                }
            } catch (err) {
                authError.textContent = err.message || 'Registration failed';
            }
            authBtn.disabled = false;
        }

        async function loginPasskey() {
            authBtn.disabled = true;
            authError.textContent = '';
            try {
                const optionsRes = await fetch('/api/admin/login/start', { method: 'POST' });
                const options = await optionsRes.json();
                options.challenge = base64ToBuffer(options.challenge);
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(c => ({
                        ...c, id: base64ToBuffer(c.id)
                    }));
                }

                const credential = await navigator.credentials.get({ publicKey: options });

                const verifyRes = await fetch('/api/admin/login/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: credential.id,
                        rawId: bufferToBase64(credential.rawId),
                        type: credential.type,
                        response: {
                            clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                            authenticatorData: bufferToBase64(credential.response.authenticatorData),
                            signature: bufferToBase64(credential.response.signature),
                            userHandle: credential.response.userHandle ? bufferToBase64(credential.response.userHandle) : null
                        }
                    })
                });

                const result = await verifyRes.json();
                if (result.success) {
                    sessionToken = result.token;
                    localStorage.setItem('adminSession', sessionToken);
                    showAdminPanel();
                } else {
                    authError.textContent = result.error || 'Login failed';
                }
            } catch (err) {
                authError.textContent = err.message || 'Login failed';
            }
            authBtn.disabled = false;
        }

        function showAdminPanel() {
            authContainer.style.display = 'none';
            adminPanel.classList.add('active');
            loadKeys();
            startAutoRefresh();
        }

        async function loadKeys() {
            try {
                const res = await fetch('/api/admin/keys', {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('adminSession');
                    location.reload();
                    return;
                }
                const data = await res.json();
                keys = data.keys;
                orphanedUploads = data.orphanedUploads || [];
                updateStats();
                renderKeysTable();
                renderFilesTable();
            } catch (err) {
                console.error('Failed to load keys:', err);
            }
        }

        // Auto-refresh every second
        let refreshInterval = null;
        function startAutoRefresh() {
            if (refreshInterval) return;
            refreshInterval = setInterval(loadKeys, 1000);
        }
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function updateStats() {
            let totalFiles = 0;
            let totalSize = 0;
            for (const k of keys) {
                totalFiles += k.uploads.length;
                for (const u of k.uploads) {
                    totalSize += u.size;
                }
            }
            // Include orphaned files in totals
            totalFiles += orphanedUploads.length;
            for (const u of orphanedUploads) {
                totalSize += u.size;
            }
            document.getElementById('totalKeys').textContent = keys.length;
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = formatBytes(totalSize);
        }

        // Keys table functions
        function handleKeysSearch() {
            keysSearchQuery = document.getElementById('keysSearchInput').value.toLowerCase().trim();
            renderKeysTable();
        }

        function setKeysSort(column) {
            if (keysSortColumn === column) {
                keysSortDirection = keysSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                keysSortColumn = column;
                keysSortDirection = column === 'label' ? 'asc' : 'desc';
            }
            renderKeysTable();
        }

        function getFilteredAndSortedKeys() {
            let filtered = keys;

            if (keysSearchQuery) {
                filtered = keys.filter(k => {
                    const labelMatch = (k.label || '').toLowerCase().includes(keysSearchQuery);
                    const keyMatch = k.key.toLowerCase().includes(keysSearchQuery);
                    return labelMatch || keyMatch;
                });
            }

            const sorted = [...filtered].sort((a, b) => {
                let cmp = 0;
                switch (keysSortColumn) {
                    case 'label':
                        cmp = (a.label || '').localeCompare(b.label || '');
                        break;
                    case 'files':
                        cmp = a.uploads.length - b.uploads.length;
                        break;
                    case 'used':
                        cmp = a.usedBytes - b.usedBytes;
                        break;
                    case 'quota':
                        cmp = a.quotaBytes - b.quotaBytes;
                        break;
                    case 'created':
                        cmp = (a.createdAt || 0) - (b.createdAt || 0);
                        break;
                }
                return keysSortDirection === 'asc' ? cmp : -cmp;
            });

            return sorted;
        }

        function renderKeysTable() {
            if (keys.length === 0) {
                keysTableContainer.innerHTML = '';
                keysEmpty.style.display = 'block';
                return;
            }
            keysEmpty.style.display = 'none';

            const filteredKeys = getFilteredAndSortedKeys();
            const sortIcon = (col) => keysSortColumn === col ? (keysSortDirection === 'asc' ? '▲' : '▼') : '';

            let html = `
                <table class="keys-table">
                    <thead>
                        <tr>
                            <th class="${keysSortColumn === 'label' ? 'active' : ''}" onclick="setKeysSort('label')">
                                Label<span class="sort-icon">${sortIcon('label')}</span>
                            </th>
                            <th class="right ${keysSortColumn === 'files' ? 'active' : ''}" onclick="setKeysSort('files')">
                                Files<span class="sort-icon">${sortIcon('files')}</span>
                            </th>
                            <th class="right ${keysSortColumn === 'used' ? 'active' : ''}" onclick="setKeysSort('used')">
                                Used<span class="sort-icon">${sortIcon('used')}</span>
                            </th>
                            <th class="right ${keysSortColumn === 'quota' ? 'active' : ''}" onclick="setKeysSort('quota')">
                                Quota<span class="sort-icon">${sortIcon('quota')}</span>
                            </th>
                            <th class="right ${keysSortColumn === 'created' ? 'active' : ''}" onclick="setKeysSort('created')">
                                Created<span class="sort-icon">${sortIcon('created')}</span>
                            </th>
                            <th class="right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (filteredKeys.length === 0 && keysSearchQuery) {
                html += `<tr><td colspan="6" style="text-align: center; color: #555; padding: 20px;">No keys match your search.</td></tr>`;
            } else {
                for (const k of filteredKeys) {
                    const usedPercent = k.quotaBytes > 0 ? (k.usedBytes / k.quotaBytes * 100) : 0;
                    const quotaClass = usedPercent >= 100 ? 'danger' : usedPercent > 90 ? 'warning' : '';

                    html += `
                        <tr>
                            <td style="color: #ccc;">${escapeHtml(k.label) || '(No label)'}</td>
                            <td style="text-align: right; color: #888;">${k.uploads.length}</td>
                            <td style="text-align: right; color: #888;">${formatBytes(k.usedBytes)}</td>
                            <td style="text-align: right;">
                                <div class="quota-bar-small">
                                    <div class="quota-fill ${quotaClass}" style="width: ${Math.min(usedPercent, 100)}%"></div>
                                </div>
                                <span style="color: #666;">${formatBytes(k.quotaBytes)}</span>
                            </td>
                            <td style="text-align: right; color: #666;">${formatDateShort(k.createdAt)}</td>
                            <td class="key-actions-cell" style="text-align: right;">
                                <a href="/#${k.key}">Upload</a>
                                <button onclick="copyKeyToClipboard('${k.key}')">Copy</button>
                                <button onclick="deleteKey('${k.key}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }
            }

            html += '</tbody></table>';
            keysTableContainer.innerHTML = html;
        }

        // Files table functions
        function handleFilesSearch() {
            filesSearchQuery = document.getElementById('filesSearchInput').value.toLowerCase().trim();
            renderFilesTable();
        }

        function setFilesSort(column) {
            if (filesSortColumn === column) {
                filesSortDirection = filesSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                filesSortColumn = column;
                filesSortDirection = column === 'filename' ? 'asc' : 'desc';
            }
            renderFilesTable();
        }

        // Build flat list of all files with key info attached
        function getAllFiles() {
            const files = [];
            for (const k of keys) {
                for (const u of k.uploads) {
                    files.push({
                        ...u,
                        keyId: k.key,
                        keyLabel: k.label || '(No label)'
                    });
                }
            }
            // Add orphaned files
            for (const u of orphanedUploads) {
                files.push({
                    ...u,
                    keyId: null,
                    keyLabel: '(Orphaned)'
                });
            }
            return files;
        }

        function getFilteredAndSortedFiles() {
            let files = getAllFiles();

            // Filter
            if (filesSearchQuery) {
                files = files.filter(f => {
                    const labelMatch = f.keyLabel.toLowerCase().includes(filesSearchQuery);
                    const keyMatch = f.keyId ? f.keyId.toLowerCase().includes(filesSearchQuery) : false;
                    const filenameMatch = f.filename.toLowerCase().includes(filesSearchQuery);
                    return labelMatch || keyMatch || filenameMatch;
                });
            }

            // Sort
            files.sort((a, b) => {
                let cmp = 0;
                switch (filesSortColumn) {
                    case 'key':
                        cmp = a.keyLabel.localeCompare(b.keyLabel);
                        break;
                    case 'filename':
                        cmp = a.filename.localeCompare(b.filename);
                        break;
                    case 'size':
                        cmp = a.size - b.size;
                        break;
                    case 'complete':
                        const aComplete = a.totalChunks > 0 && a.chunksReceived === a.totalChunks ? 1 : 0;
                        const bComplete = b.totalChunks > 0 && b.chunksReceived === b.totalChunks ? 1 : 0;
                        cmp = aComplete - bComplete;
                        break;
                    case 'created':
                        cmp = (a.createdAt || 0) - (b.createdAt || 0);
                        break;
                }
                return filesSortDirection === 'asc' ? cmp : -cmp;
            });

            return files;
        }

        function renderFilesTable() {
            const files = getFilteredAndSortedFiles();

            if (getAllFiles().length === 0) {
                filesTableContainer.innerHTML = '';
                filesEmpty.style.display = 'block';
                return;
            }
            filesEmpty.style.display = 'none';

            const sortIcon = (col) => filesSortColumn === col ? (filesSortDirection === 'asc' ? '▲' : '▼') : '';

            let html = `
                <table class="files-table">
                    <thead>
                        <tr>
                            <th class="${filesSortColumn === 'key' ? 'active' : ''}" onclick="setFilesSort('key')">
                                Key<span class="sort-icon">${sortIcon('key')}</span>
                            </th>
                            <th class="${filesSortColumn === 'filename' ? 'active' : ''}" onclick="setFilesSort('filename')">
                                Filename<span class="sort-icon">${sortIcon('filename')}</span>
                            </th>
                            <th class="right ${filesSortColumn === 'size' ? 'active' : ''}" onclick="setFilesSort('size')">
                                Size<span class="sort-icon">${sortIcon('size')}</span>
                            </th>
                            <th class="${filesSortColumn === 'complete' ? 'active' : ''}" onclick="setFilesSort('complete')">
                                Complete<span class="sort-icon">${sortIcon('complete')}</span>
                            </th>
                            <th class="right ${filesSortColumn === 'created' ? 'active' : ''}" onclick="setFilesSort('created')">
                                Created<span class="sort-icon">${sortIcon('created')}</span>
                            </th>
                            <th class="right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (files.length === 0 && filesSearchQuery) {
                html += `<tr><td colspan="6" style="text-align: center; color: #555; padding: 20px;">No files match your search.</td></tr>`;
            } else {
                for (const f of files) {
                    const isComplete = f.totalChunks > 0 && f.chunksReceived === f.totalChunks;

                    html += `
                        <tr>
                            <td style="color: #888;">${escapeHtml(f.keyLabel)}</td>
                            <td class="file-name-cell">
                                <a class="file-name-link" href="/download/${f.id}" title="${escapeHtml(f.filename)}">${escapeHtml(f.filename)}</a>
                            </td>
                            <td class="file-size-cell" style="text-align: right;">${formatBytes(f.size)}</td>
                            <td style="color: ${isComplete ? '#888' : '#666'};">${isComplete ? 'Complete' : 'Incomplete'}</td>
                            <td class="file-date-cell" style="text-align: right;">${formatDateShort(f.createdAt)}</td>
                            <td class="file-actions-cell" style="text-align: right;">
                                <button onclick="copyLink('${f.id}')">Copy</button>
                                <button onclick="deleteUpload('${f.id}', '${f.keyId || ''}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }
            }

            html += '</tbody></table>';
            filesTableContainer.innerHTML = html;
        }

        function copyKeyToClipboard(key) {
            navigator.clipboard.writeText(key).then(() => {
                // Brief feedback could be added here
            });
        }

        async function createKey() {
            const label = document.getElementById('keyLabel').value;
            const quotaValue = parseFloat(document.getElementById('keyQuota').value);
            const quotaUnit = document.getElementById('keyQuotaUnit').value;

            if (!quotaValue || quotaValue <= 0) {
                alert('Please enter a valid quota');
                return;
            }

            try {
                const res = await fetch('/api/admin/keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ label, quotaValue, quotaUnit })
                });

                const data = await res.json();
                if (data.key) {
                    document.getElementById('newKeyValue').textContent = data.key;
                    document.getElementById('newKeyDisplay').style.display = 'block';
                    document.getElementById('keyLabel').value = '';
                    loadKeys();
                } else {
                    alert(data.error || 'Failed to create key');
                }
            } catch (err) {
                alert('Failed to create key: ' + err.message);
            }
        }

        function copyKey(key, el) {
            navigator.clipboard.writeText(key).then(() => {
                el.classList.add('copied');
                setTimeout(() => {
                    el.classList.remove('copied');
                }, 1500);
            });
        }

        function copyNewKey() {
            const key = document.getElementById('newKeyValue').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        async function deleteKey(key) {
            if (!confirm('Delete this upload key? Files will be moved to Orphaned Files.')) return;

            try {
                const res = await fetch(`/api/admin/keys/${key}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.ok) {
                    loadKeys();
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function copyLink(id) {
            const url = `${window.location.origin}/download/${id}`;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        async function deleteUpload(id, key) {
            if (!confirm('Delete this upload? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/admin/uploads/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.ok) {
                    loadKeys();
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function logout() {
            stopAutoRefresh();
            sessionToken = null;
            localStorage.removeItem('adminSession');
            adminPanel.classList.remove('active');
            authContainer.style.display = 'block';
            checkAuth();
        }

        // Helpers
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const d = new Date(timestamp);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateShort(timestamp) {
            if (!timestamp) return '--';
            const d = new Date(timestamp);
            return d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function base64ToBuffer(base64) {
            const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }

        function bufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
