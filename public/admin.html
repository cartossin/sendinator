<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sendinator</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            background: #1a1a2e;
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        h1 {
            font-size: 2em;
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        h2 { margin: 0 0 15px 0; color: #fff; font-size: 1.3em; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .home-link {
            color: #667eea;
            text-decoration: none;
        }
        .home-link:hover { text-decoration: underline; }

        /* Auth section */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: #252542;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
        }
        .auth-container h2 { margin: 0 0 10px 0; }
        .auth-container p { color: #888; margin-bottom: 30px; }
        .auth-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .auth-error { color: #ef4444; margin-top: 15px; }

        /* Admin panel */
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }

        /* Create key form */
        .create-key-section {
            background: #252542;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .create-key-form {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.85em; color: #888; }
        .form-group input {
            padding: 10px 14px;
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
        }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .create-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .create-btn:hover { background: #5a6fd6; }

        /* Key card */
        .key-card {
            background: #252542;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .key-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            gap: 15px;
        }
        .key-header:hover { background: rgba(102, 126, 234, 0.1); }
        .key-toggle {
            font-size: 0.9em;
            color: #667eea;
            width: 20px;
            transition: transform 0.2s;
        }
        .key-card.expanded .key-toggle { transform: rotate(90deg); }
        .key-info { flex: 1; }
        .key-label { font-weight: 600; font-size: 1.1em; }
        .key-label .key-string { font-family: monospace; font-size: 0.85em; color: #888; margin-left: 10px; }
        .key-meta { font-size: 0.85em; color: #888; margin-top: 4px; }
        .key-quota {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .quota-bar {
            width: 150px;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }
        .quota-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }
        .quota-fill.warning { background: #f59e0b; }
        .quota-fill.danger { background: #ef4444; }
        .quota-text { font-size: 0.8em; color: #888; }
        .key-actions {
            display: flex;
            gap: 8px;
        }
        .copy-key-btn, .delete-key-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            border: 1px solid;
        }
        .copy-key-btn { background: transparent; border-color: #667eea; color: #667eea; }
        .copy-key-btn:hover { background: #667eea; color: white; }
        .delete-key-btn { background: transparent; border-color: #ef4444; color: #ef4444; }
        .delete-key-btn:hover { background: #ef4444; color: white; }

        /* Key uploads */
        .key-uploads {
            display: none;
            border-top: 1px solid #333;
            padding: 15px 20px;
            background: #1e1e38;
        }
        .key-card.expanded .key-uploads { display: block; }
        .upload-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            gap: 15px;
        }
        .upload-row:last-child { border-bottom: none; }
        .upload-filename {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .upload-size { color: #888; font-size: 0.9em; min-width: 80px; }
        .upload-progress { min-width: 100px; }
        .progress-bar {
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; background: #ef4444; }
        .progress-fill.complete { background: #10b981; }
        .progress-text { font-size: 0.75em; color: #888; margin-top: 2px; }
        .upload-actions { display: flex; gap: 8px; }
        .upload-actions button {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            border: 1px solid;
            background: transparent;
        }
        .upload-copy { border-color: #667eea; color: #667eea; }
        .upload-copy:hover { background: #667eea; color: white; }
        .upload-delete { border-color: #ef4444; color: #ef4444; }
        .upload-delete:hover { background: #ef4444; color: white; }
        .no-uploads { color: #666; font-style: italic; padding: 10px 0; }

        /* Stats */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #252542;
            padding: 15px 20px;
            border-radius: 10px;
            min-width: 120px;
        }
        .stat-value { font-size: 1.5em; font-weight: 600; color: #fff; }
        .stat-label { font-size: 0.85em; color: #888; margin-top: 4px; }

        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #252542;
            border: 1px solid #444;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
        }
        .refresh-btn:hover { border-color: #667eea; color: #667eea; }
        .version { position: fixed; bottom: 10px; right: 10px; color: #444; font-size: 0.75em; }
        .new-key-display {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #10b981;
        }
        .new-key-display label { display: block; color: #10b981; margin-bottom: 8px; font-size: 0.9em; }
        .new-key-value {
            font-family: monospace;
            font-size: 1.2em;
            color: #fff;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div class="auth-container" id="authContainer">
        <h2 id="authTitle">Admin Setup</h2>
        <p id="authDesc">Create a passkey to secure your admin panel.</p>
        <button class="auth-btn" id="authBtn">Create Passkey</button>
        <div class="auth-error" id="authError"></div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1>Sendinator Admin</h1>
            <div class="header-right">
                <a href="/" class="home-link">Back to Upload</a>
                <a href="#" class="home-link" onclick="logout(); return false;">Logout</a>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalKeys">0</div>
                <div class="stat-label">Upload Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">Total Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 B</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <div class="create-key-section">
            <h2>Create Upload Key</h2>
            <div class="create-key-form">
                <div class="form-group">
                    <label>Label (optional)</label>
                    <input type="text" id="keyLabel" placeholder="e.g., John's key">
                </div>
                <div class="form-group">
                    <label>Quota</label>
                    <div style="display: flex; gap: 6px;">
                        <input type="number" id="keyQuota" value="10" min="1" step="1" style="width: 80px;">
                        <select id="keyQuotaUnit" style="padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 8px; color: #fff;">
                            <option value="MB">MB</option>
                            <option value="GB" selected>GB</option>
                            <option value="TB">TB</option>
                        </select>
                    </div>
                </div>
                <button class="create-btn" onclick="createKey()">Create Key</button>
            </div>
            <div class="new-key-display" id="newKeyDisplay" style="display: none;">
                <label>New Upload Key (copy it now - won't be shown again!):</label>
                <div class="new-key-value" id="newKeyValue"></div>
            </div>
        </div>

        <div class="section-header">
            <h2>Upload Keys</h2>
            <button class="refresh-btn" onclick="loadKeys()">Refresh</button>
        </div>

        <div id="keysList"></div>
        <div class="empty-state" id="emptyState" style="display: none;">
            No upload keys yet. Create one above to get started.
        </div>
    </div>

    <div class="version">v3.0.0</div>

    <script>
        let keys = [];
        let sessionToken = null;
        let expandedKeys = new Set();

        const authContainer = document.getElementById('authContainer');
        const adminPanel = document.getElementById('adminPanel');
        const authTitle = document.getElementById('authTitle');
        const authDesc = document.getElementById('authDesc');
        const authBtn = document.getElementById('authBtn');
        const authError = document.getElementById('authError');
        const keysList = document.getElementById('keysList');
        const emptyState = document.getElementById('emptyState');

        // Check auth status on load
        async function checkAuth() {
            if (!window.PublicKeyCredential) {
                authTitle.textContent = 'Not Supported';
                authDesc.textContent = 'WebAuthn is not available. You need HTTPS or localhost.';
                authBtn.style.display = 'none';
                return;
            }

            try {
                const res = await fetch('/api/admin/status');
                const data = await res.json();

                if (!data.passkeyExists) {
                    authTitle.textContent = 'Admin Setup';
                    authDesc.textContent = 'Create a passkey to secure your admin panel.';
                    authBtn.textContent = 'Create Passkey';
                    authBtn.onclick = registerPasskey;
                } else {
                    authTitle.textContent = 'Admin Login';
                    authDesc.textContent = 'Authenticate with your passkey.';
                    authBtn.textContent = 'Login with Passkey';
                    authBtn.onclick = loginPasskey;
                }
            } catch (err) {
                authError.textContent = 'Failed to check auth status';
            }
        }

        async function registerPasskey() {
            authBtn.disabled = true;
            authError.textContent = '';
            try {
                const optionsRes = await fetch('/api/admin/register/start', { method: 'POST' });
                const options = await optionsRes.json();
                options.challenge = base64ToBuffer(options.challenge);
                options.user.id = base64ToBuffer(options.user.id);

                const credential = await navigator.credentials.create({ publicKey: options });

                const verifyRes = await fetch('/api/admin/register/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: credential.id,
                        rawId: bufferToBase64(credential.rawId),
                        type: credential.type,
                        response: {
                            clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                            attestationObject: bufferToBase64(credential.response.attestationObject)
                        }
                    })
                });

                const result = await verifyRes.json();
                if (result.success) {
                    sessionToken = result.token;
                    showAdminPanel();
                } else {
                    authError.textContent = result.error || 'Registration failed';
                }
            } catch (err) {
                authError.textContent = err.message || 'Registration failed';
            }
            authBtn.disabled = false;
        }

        async function loginPasskey() {
            authBtn.disabled = true;
            authError.textContent = '';
            try {
                const optionsRes = await fetch('/api/admin/login/start', { method: 'POST' });
                const options = await optionsRes.json();
                options.challenge = base64ToBuffer(options.challenge);
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(c => ({
                        ...c, id: base64ToBuffer(c.id)
                    }));
                }

                const credential = await navigator.credentials.get({ publicKey: options });

                const verifyRes = await fetch('/api/admin/login/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: credential.id,
                        rawId: bufferToBase64(credential.rawId),
                        type: credential.type,
                        response: {
                            clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                            authenticatorData: bufferToBase64(credential.response.authenticatorData),
                            signature: bufferToBase64(credential.response.signature),
                            userHandle: credential.response.userHandle ? bufferToBase64(credential.response.userHandle) : null
                        }
                    })
                });

                const result = await verifyRes.json();
                if (result.success) {
                    sessionToken = result.token;
                    showAdminPanel();
                } else {
                    authError.textContent = result.error || 'Login failed';
                }
            } catch (err) {
                authError.textContent = err.message || 'Login failed';
            }
            authBtn.disabled = false;
        }

        function showAdminPanel() {
            authContainer.style.display = 'none';
            adminPanel.classList.add('active');
            loadKeys();
        }

        async function loadKeys() {
            try {
                const res = await fetch('/api/admin/keys', {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.status === 401) {
                    location.reload();
                    return;
                }
                const data = await res.json();
                keys = data.keys;
                updateStats();
                renderKeys();
            } catch (err) {
                console.error('Failed to load keys:', err);
            }
        }

        function updateStats() {
            let totalFiles = 0;
            let totalSize = 0;
            for (const k of keys) {
                totalFiles += k.uploads.length;
                for (const u of k.uploads) {
                    totalSize += u.size;
                }
            }
            document.getElementById('totalKeys').textContent = keys.length;
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = formatBytes(totalSize);
        }

        function renderKeys() {
            if (keys.length === 0) {
                keysList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            keysList.innerHTML = keys.map(k => {
                const usedPercent = k.quotaBytes > 0 ? (k.usedBytes / k.quotaBytes * 100) : 0;
                const quotaClass = usedPercent > 90 ? 'danger' : usedPercent > 70 ? 'warning' : '';
                const isExpanded = expandedKeys.has(k.key);

                return `
                    <div class="key-card ${isExpanded ? 'expanded' : ''}" data-key="${k.key}">
                        <div class="key-header" onclick="toggleKey('${k.key}')">
                            <div class="key-toggle">&#9654;</div>
                            <div class="key-info">
                                <div class="key-label">
                                    ${escapeHtml(k.label) || '(No label)'}
                                    <span class="key-string">${k.key.slice(0, 8)}...</span>
                                </div>
                                <div class="key-meta">${k.uploads.length} file${k.uploads.length !== 1 ? 's' : ''} &bull; Created ${formatDate(k.createdAt)}</div>
                            </div>
                            <div class="key-quota">
                                <div class="quota-bar">
                                    <div class="quota-fill ${quotaClass}" style="width: ${Math.min(usedPercent, 100)}%"></div>
                                </div>
                                <div class="quota-text">${formatBytes(k.usedBytes)} / ${formatBytes(k.quotaBytes)}</div>
                            </div>
                            <div class="key-actions" onclick="event.stopPropagation()">
                                <button class="copy-key-btn" onclick="copyKey('${k.key}')">Copy Key</button>
                                <button class="delete-key-btn" onclick="deleteKey('${k.key}')">Delete</button>
                            </div>
                        </div>
                        <div class="key-uploads">
                            ${k.uploads.length === 0 ? '<div class="no-uploads">No uploads yet</div>' : k.uploads.map(u => {
                                const progress = u.totalChunks > 0 ? (u.chunksReceived / u.totalChunks * 100) : 0;
                                const isComplete = u.totalChunks > 0 && u.chunksReceived === u.totalChunks;
                                return `
                                    <div class="upload-row">
                                        <div class="upload-filename" title="${escapeHtml(u.filename)}">${escapeHtml(u.filename)}</div>
                                        <div class="upload-size">${formatBytes(u.size)}</div>
                                        <div class="upload-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill ${isComplete ? 'complete' : ''}" style="width: ${progress}%"></div>
                                            </div>
                                            <div class="progress-text">${u.chunksReceived}/${u.totalChunks}</div>
                                        </div>
                                        <div class="upload-actions">
                                            <button class="upload-copy" onclick="copyLink('${u.id}')">Copy Link</button>
                                            <button class="upload-delete" onclick="deleteUpload('${u.id}', '${k.key}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleKey(key) {
            if (expandedKeys.has(key)) {
                expandedKeys.delete(key);
            } else {
                expandedKeys.add(key);
            }
            renderKeys();
        }

        async function createKey() {
            const label = document.getElementById('keyLabel').value;
            const quotaValue = parseFloat(document.getElementById('keyQuota').value);
            const quotaUnit = document.getElementById('keyQuotaUnit').value;

            if (!quotaValue || quotaValue <= 0) {
                alert('Please enter a valid quota');
                return;
            }

            try {
                const res = await fetch('/api/admin/keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ label, quotaValue, quotaUnit })
                });

                const data = await res.json();
                if (data.key) {
                    document.getElementById('newKeyValue').textContent = data.key;
                    document.getElementById('newKeyDisplay').style.display = 'block';
                    document.getElementById('keyLabel').value = '';
                    loadKeys();
                } else {
                    alert(data.error || 'Failed to create key');
                }
            } catch (err) {
                alert('Failed to create key: ' + err.message);
            }
        }

        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        async function deleteKey(key) {
            if (!confirm('Delete this upload key and all its uploads? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/admin/keys/${key}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.ok) {
                    expandedKeys.delete(key);
                    loadKeys();
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function copyLink(id) {
            const url = `${window.location.origin}/download/${id}`;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1500);
            });
        }

        async function deleteUpload(id, key) {
            if (!confirm('Delete this upload? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/admin/uploads/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                if (res.ok) {
                    loadKeys();
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function logout() {
            sessionToken = null;
            adminPanel.classList.remove('active');
            authContainer.style.display = 'block';
            checkAuth();
        }

        // Helpers
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const d = new Date(timestamp);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function base64ToBuffer(base64) {
            const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }

        function bufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
